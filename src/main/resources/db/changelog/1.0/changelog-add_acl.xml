<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="1_add_acl" author="bse71">

        <sql>
            create table acl_sid(
            id bigserial not null primary key,
            principal boolean not null,
            sid varchar(100) not null,
            constraint unique_uk_1 unique(sid,principal)
            );

            create table acl_class(
            id bigserial not null primary key,
            class varchar(100) not null,
            class_id_type varchar(100),
            constraint unique_uk_2 unique(class)
            );

            create table acl_object_identity(
            id bigserial primary key,
            object_id_class bigint not null,
            object_id_identity varchar(36) not null,
            parent_object bigint,
            owner_sid bigint,
            entries_inheriting boolean not null,
            constraint unique_uk_3 unique(object_id_class,object_id_identity),
            constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
            constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
            constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
            );

            create table acl_entry(
            id bigserial primary key,
            acl_object_identity bigint not null,
            ace_order int not null,
            sid bigint not null,
            mask integer not null,
            granting boolean not null,
            audit_success boolean not null,
            audit_failure boolean not null,
            constraint unique_uk_4 unique(acl_object_identity,ace_order),
            constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
            constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
            );

            INSERT INTO acl_class (id, class) VALUES
            (1, 'ru.bse71.learnup.spring.rest.model.Post'),
            (2, 'ru.bse71.learnup.spring.rest.model.Comment');

            INSERT INTO acl_sid (id, principal, sid) VALUES
            (1, false, 'ROLE_USER'),
            (2, true, 'user'),
            (3, false, 'ROLE_ADMIN');

            INSERT INTO acl_object_identity
            (id, object_id_class, object_id_identity,
            parent_object, owner_sid, entries_inheriting)
            VALUES
            (1, 1, 1, NULL, 3, true),
            (2, 1, 2, NULL, 3, true),
            (3, 1, 3, NULL, 3, true),
            (4, 2, 6, NULL, 3, true),
            (5, 2, 7, NULL, 3, true),
            (6, 2, 8, NULL, 3, true),
            (7, 2, 9, NULL, 3, true);

            INSERT INTO acl_entry
            (id, acl_object_identity, ace_order,
            sid, mask, granting, audit_success, audit_failure)
            VALUES
            (1, 1, 1, 1, 1, true, true, true),
            (2, 2, 1, 2, 1, true, true, true),
            (3, 3, 1, 3, 1, true, true, true),
            (4, 3, 2, 3, 1, true, true, true);
        </sql>

    </changeSet>

</databaseChangeLog>